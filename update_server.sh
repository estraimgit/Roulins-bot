#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ user1@176.108.243.54
# –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –∫–ª—é—á–∏, —Ç–æ–∫–µ–Ω—ã –∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

set -e  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üîÑ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Roulins_Bot –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo "================================================"

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Ä–≤–µ—Ä–∞
SERVER="user1@176.108.243.54"
APP_DIR="/home/user1/prisoners-dilemma-bot"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# 1. –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é .env —Ñ–∞–π–ª–∞
echo -e "\n${YELLOW}üì¶ –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ .env —Ñ–∞–π–ª–∞...${NC}"
ssh $SERVER "cd $APP_DIR && cp .env .env.backup.\$(date +%Y%m%d_%H%M%S) 2>/dev/null || echo '–§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω'"
echo -e "${GREEN}‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è .env —Å–æ–∑–¥–∞–Ω–∞${NC}"

# 2. –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo -e "\n${YELLOW}üì¶ –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...${NC}"
ssh $SERVER "cd $APP_DIR && mkdir -p data_backup_\$(date +%Y%m%d_%H%M%S) && cp -r data/* data_backup_\$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || echo '–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è data –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'"
echo -e "${GREEN}‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞${NC}"

# 3. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
echo -e "\n${YELLOW}üõë –®–∞–≥ 3: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...${NC}"
ssh $SERVER "cd $APP_DIR && docker-compose down"
echo -e "${GREEN}‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"

# 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π .env –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
echo -e "\n${YELLOW}üíæ –®–∞–≥ 4: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${NC}"
ssh $SERVER "cd $APP_DIR && cp .env .env.temp 2>/dev/null || echo '–§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω'"
echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞${NC}"

# 5. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git
echo -e "\n${YELLOW}üì• –®–∞–≥ 5: –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ Git...${NC}"
ssh $SERVER "cd $APP_DIR && git stash && git pull origin main"
echo -e "${GREEN}‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã${NC}"

# 6. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env —Ñ–∞–π–ª
echo -e "\n${YELLOW}üîß –®–∞–≥ 6: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${NC}"
ssh $SERVER "cd $APP_DIR && mv .env.temp .env 2>/dev/null || echo '–§–∞–π–ª .env.temp –Ω–µ –Ω–∞–π–¥–µ–Ω'"
echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞${NC}"

# 7. –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
echo -e "\n${YELLOW}üî® –®–∞–≥ 7: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞...${NC}"
ssh $SERVER "cd $APP_DIR && docker-compose build --no-cache"
echo -e "${GREEN}‚úÖ Docker –æ–±—Ä–∞–∑ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω${NC}"

# 8. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo -e "\n${YELLOW}üîç –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${NC}"
if ssh $SERVER "cd $APP_DIR && docker-compose run --rm prisoners-dilemma-bot python -c 'from config.settings import Config; Config.validate(); print(\"OK\")'" 2>/dev/null; then
    echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞${NC}"
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω–∞${NC}"
    echo -e "${YELLOW}–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ${NC}"
    exit 1
fi

# 9. –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo -e "\n${YELLOW}üöÄ –®–∞–≥ 9: –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞...${NC}"
ssh $SERVER "cd $APP_DIR && docker-compose up -d"
echo -e "${GREEN}‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω${NC}"

# 10. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo -e "\n${YELLOW}üìä –®–∞–≥ 10: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...${NC}"
sleep 5
ssh $SERVER "cd $APP_DIR && docker-compose ps"

# –í—ã–≤–æ–¥–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
echo -e "\n${GREEN}============================================${NC}"
echo -e "${GREEN}‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!${NC}"
echo -e "${GREEN}============================================${NC}"
echo ""
echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ:"
echo "  –°–µ—Ä–≤–µ—Ä: $SERVER"
echo "  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $APP_DIR"
echo "  –°—Ç–∞—Ç—É—Å: docker-compose ps"
echo ""
echo "üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: ./server-manage.sh logs"
echo "  –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞: ./server-manage.sh status"
echo "  –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ./server-manage.sh stop"
echo "  –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: ./server-manage.sh restart"
echo ""
echo "üíæ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ–∑–¥–∞–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo ""

